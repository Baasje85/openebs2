{% extends "base.html" %}
{% load leaflet_tags %}

{% block content %}
    <h2>Dashboard Ritten</h2>
    <h3>Daggrafiek</h3>
    <div id="daychart"></div>

    <h3>Actueel</h3>
    <p class="help-text">Ritten die in de afgelopen 15 minuten reden</p>

    <table class="table table-striped table-condensed table-bordered col-lg-8">
        <tr>
            <th class="col-lg-2">Lijn</th>
            <th class="col-lg-3">Gereden</th>
            <th class="col-lg-3">Verwacht</th>
            <th class="col-lg-4">Percentage</th>
        </tr>
        {% for lijn in list|dictsort:"percentage" %}
            <tr class="line" data-line="{{ lijn.lineplanningnumber }}">
                <td><strong>{{ lijn.publiclinenumber }}</strong></td>
                <td>{{ lijn.seen }}</td>
                <td>{{ lijn.expected }}</td>
                <td>{{ lijn.percentage }}%
                    <a class="btn btn-primary btn-xs pull-right view-detail" data-toggle="collapse" data-target="#l{{ lijn.lineplanningnumber }}">
                        Details
                    </a>
                </td>
            </tr>
            <tr class="collapse" id="l{{ lijn.lineplanningnumber }}">
                <td></td>
                <td colspan="4">
                    <ul class="row">
                        {% for vehicle in lijn.list %}
                            {% if vehicle.log_id %}
                                <li class="col-xs-4">{{ vehicle.vehiclenumber }} - <small>Rit {{ vehicle.journeynumber }}</small></li>
                            {% else %}
                                <li class="col-xs-4"><small style="color: red;">Rit {{ vehicle.journeynumber }}</small></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </td>
            </tr>
        {% endfor %}
    </table>

    <h3>Voertuigposities</h3>
    {% leaflet_map "smallmap" callback="main_map_init" %}

{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/morris-0.4.3.min.css">
    {% leaflet_css %}
{% endblock %}

{% block extra_js %}
    <script src="{{ STATIC_URL }}js/raphael-min.js"></script>
    <script src="{{ STATIC_URL }}js/morris-0.4.3.min.js"></script>
    {% leaflet_js %}
{% endblock %}

{% block js_init %}
    $.getJSON("{% url 'ajax_graph' date_today %}", makeGraph);
{% endblock %}

{% block js %}
    var leafletMap, leafletLayer;
    var geojsonMarkerOptions = {
        radius: 8,
        fillColor: "#ff0000",
        color: "#000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
    };

    function onEachFeature(feature, layer) {
        text = "<b>Voertuig:</b> "+feature.properties.vehiclenumber+"<br />";
        text += "<b>Rit:</b> "+feature.properties.journeynumber+"<br />";
        text += "<b>Punctualiteit:</b> "+feature.properties.last_punctuality+"s<br />";
        layer.bindPopup(text);
    }

    function main_map_init (map, options) {
        leafletMap = map;
        leafletMap.setView(new L.LatLng(52.05, 4.32), 12);
        getData();
        window.setInterval(getData, 30000);
    }

    function getData() {
        $.getJSON("{% url 'ajax_vehicles' %}", function (data) {
            if (leafletLayer) {
                leafletMap.removeLayer(leafletLayer);
            }
            leafletLayer = L.geoJson(data, {
                onEachFeature: onEachFeature,
                pointToLayer: function (feature, latlng) {
                    if (feature.properties.vehiclenumber[0] == '1') {
                        geojsonMarkerOptions.fillColor = '#ffffff';
                    }
                    if (feature.properties.vehiclenumber[0] == '3') {
                        geojsonMarkerOptions.fillColor = '#ff0000';
                    }
                    if (feature.properties.vehiclenumber[0] == '4') {
                        geojsonMarkerOptions.fillColor = '#000099';
                    }
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                }
            })
            leafletLayer.addTo(leafletMap);
        });
    }

    function makeGraph(data) {
        new Morris.Line({
          element: 'daychart',
          data: data.points,
          xkey: 'date',
          ykeys: ['expected', 'seen'],
          lineColors: ['#000000', '#dd0000'],
          labels: ['Ritten verwacht','Ritten gereden']
        });
    }
{% endblock %}